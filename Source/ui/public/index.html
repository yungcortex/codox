<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Codox v2.1</title>
<style>
:root {
  --bg-dark: #0a0a0a;
  --bg-panel: #151515;
  --bg-module: #1a1a1a;
  --bg-input: #222;
  --accent: #00d4aa;
  --accent-dim: #009977;
  --text: #e0e0e0;
  --text-dim: #777;
  --orange: #ff8c42;
  --purple: #9b59b6;
  --blue: #3498db;
  --red: #e74c3c;
  --yellow: #f1c40f;
  --green: #2ecc71;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg-dark);
  color: var(--text);
  font-size: 11px;
  overflow: hidden;
  user-select: none;
}

.plugin {
  width: 1100px;
  height: 720px;
  background: linear-gradient(180deg, #151515 0%, #0a0a0a 100%);
  display: flex;
  flex-direction: column;
}

/* ===== HEADER ===== */
.header {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  background: #111;
  border-bottom: 1px solid #2a2a2a;
  height: 48px;
  gap: 12px;
}

.logo {
  font-size: 24px;
  font-weight: 800;
  color: var(--accent);
  letter-spacing: 3px;
  text-shadow: 0 0 15px var(--accent);
}

.preset-section {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1;
  margin-left: 20px;
}

.preset-nav {
  background: #222;
  border: 1px solid #333;
  color: var(--text);
  width: 26px;
  height: 26px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 12px;
}
.preset-nav:hover { background: #333; border-color: var(--accent); }

#preset_select {
  background: #1a1a1a;
  border: 1px solid #333;
  color: var(--text);
  padding: 6px 12px;
  width: 200px;
  border-radius: 4px;
}

.preset-btn {
  background: #222;
  border: 1px solid #333;
  color: var(--text);
  padding: 6px 14px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
}
.preset-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }

.master-section {
  display: flex;
  align-items: center;
  gap: 8px;
}
.master-label { color: var(--text-dim); font-size: 9px; text-transform: uppercase; }

/* ===== NAVIGATION TABS ===== */
.nav-tabs {
  display: flex;
  background: #0d0d0d;
  border-bottom: 1px solid #2a2a2a;
  padding: 0 16px;
}

.nav-tab {
  padding: 10px 24px;
  cursor: pointer;
  color: var(--text-dim);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.nav-tab:hover { color: var(--text); }
.nav-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

/* ===== MAIN LAYOUT ===== */
.main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* Left side: Tab content */
.tab-content {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
}

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* Right side: Always visible (Filter, Envelopes, LFOs) */
.sidebar {
  width: 320px;
  background: #0d0d0d;
  border-left: 1px solid #2a2a2a;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
}

/* ===== MODULES ===== */
.module {
  background: var(--bg-module);
  border-radius: 6px;
  border: 1px solid #2a2a2a;
  padding: 12px;
}

.module-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid #2a2a2a;
}

.module-title {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ===== OSC PAGE ===== */
.osc-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.osc-module {
  background: var(--bg-module);
  border-radius: 8px;
  border: 1px solid #2a2a2a;
  padding: 14px;
}

.osc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.osc-title {
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 1px;
}
.osc-title.a { color: var(--accent); }
.osc-title.b { color: var(--orange); }
.osc-title.sub { color: var(--purple); }
.osc-title.noise { color: var(--text-dim); }

.osc-wave {
  background: #111;
  border-radius: 6px;
  height: 80px;
  margin-bottom: 12px;
  border: 1px solid #222;
}

.osc-controls {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.osc-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-top: 10px;
}

.sub-noise-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 12px;
}

/* ===== FX PAGE ===== */
.fx-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.fx-unit {
  background: var(--bg-module);
  border-radius: 6px;
  border: 1px solid #2a2a2a;
  padding: 12px;
  cursor: grab;
}
.fx-unit:hover { border-color: #444; }
.fx-unit.dragging { opacity: 0.5; border-color: var(--accent); }

.fx-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.fx-name {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.fx-toggle {
  width: 16px;
  height: 16px;
  background: #333;
  border-radius: 4px;
  cursor: pointer;
  border: 1px solid #444;
}
.fx-toggle.active { background: var(--accent); border-color: var(--accent); }

.fx-controls {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}

/* ===== SETTINGS PAGE ===== */
.settings-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

/* ===== KNOBS ===== */
.knob-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.knob {
  width: 36px;
  height: 36px;
  position: relative;
  cursor: pointer;
}
.knob.sm { width: 30px; height: 30px; }
.knob.lg { width: 44px; height: 44px; }

.knob-bg {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: linear-gradient(145deg, #252525, #1a1a1a);
  border: 2px solid #333;
}

.knob-pointer {
  position: absolute;
  width: 3px;
  height: 40%;
  background: var(--accent);
  left: 50%;
  top: 10%;
  transform-origin: bottom center;
  transform: translateX(-50%) rotate(-135deg);
  border-radius: 2px;
}

.knob-label {
  font-size: 8px;
  color: var(--text-dim);
  text-transform: uppercase;
  text-align: center;
}

/* ===== MODULATION RING (Serum-style) ===== */
.knob-mod-ring {
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}

.knob.has-mod .knob-mod-ring {
  opacity: 1;
}

/* SVG ring for modulation depth visualization */
.mod-ring-svg {
  width: 100%;
  height: 100%;
}

.mod-ring-arc {
  fill: none;
  stroke: var(--blue);
  stroke-width: 3;
  stroke-linecap: round;
  filter: drop-shadow(0 0 4px var(--blue));
}

/* Modulation indicator dot */
.knob-mod-dot {
  position: absolute;
  width: 6px;
  height: 6px;
  background: var(--blue);
  border-radius: 50%;
  top: -3px;
  left: 50%;
  transform: translateX(-50%);
  box-shadow: 0 0 6px var(--blue);
  display: none;
}

.knob.has-mod .knob-mod-dot {
  display: block;
}

/* Drag target highlight */
.knob.mod-drag-target {
  outline: 2px dashed var(--blue);
  outline-offset: 4px;
}

.knob.mod-drag-target .knob-bg {
  border-color: var(--blue);
}

/* Mod source drag indicator */
.mod-source-dragging {
  opacity: 0.5;
}

/* LFO/Env drag handles */
.mod-source-handle {
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 20px;
  height: 8px;
  background: var(--blue);
  border-radius: 4px;
  cursor: grab;
  opacity: 0;
  transition: opacity 0.2s;
}

.module:hover .mod-source-handle {
  opacity: 0.6;
}

.mod-source-handle:hover {
  opacity: 1 !important;
  transform: translateX(-50%) scale(1.2);
}

.mod-source-handle:active {
  cursor: grabbing;
}

/* Modulation drag ghost */
#mod-drag-ghost {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  background: var(--blue);
  color: #000;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,0,0,0.5);
  display: none;
}

/* ===== SELECTS ===== */
select {
  background: var(--bg-input);
  border: 1px solid #333;
  color: var(--text);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  cursor: pointer;
}
select:focus { outline: none; border-color: var(--accent); }

/* ===== DISPLAYS ===== */
.env-display {
  background: #111;
  border-radius: 4px;
  height: 45px;
  margin-bottom: 8px;
  border: 1px solid #222;
}

.lfo-display {
  background: #111;
  border-radius: 4px;
  height: 35px;
  margin-bottom: 6px;
  border: 1px solid #222;
}

.filter-display {
  background: #111;
  border-radius: 4px;
  height: 55px;
  margin-bottom: 10px;
  border: 1px solid #222;
}

/* ===== MACROS ===== */
.macros-bar {
  background: #0d0d0d;
  border-top: 1px solid #2a2a2a;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.macros-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--yellow);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.macros-row {
  display: flex;
  gap: 16px;
  flex: 1;
  justify-content: center;
}

/* ===== MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-panel);
  border-radius: 8px;
  padding: 24px;
  border: 1px solid #333;
  min-width: 320px;
}

.modal-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--accent);
}

.modal-input {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-input);
  border: 1px solid #333;
  border-radius: 4px;
  color: var(--text);
  margin-bottom: 16px;
}
.modal-input:focus { outline: none; border-color: var(--accent); }

.modal-btns {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.modal-btn {
  padding: 8px 18px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  transition: transform 0.1s, opacity 0.1s;
}
.modal-btn:hover { opacity: 0.9; }
.modal-btn:active { transform: scale(0.96); }
.modal-btn.primary { background: var(--accent); color: #000; }
.modal-btn.secondary { background: #333; color: var(--text); }

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #111; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #444; }

/* ===== MIX TAB (Serum 2 style routing) ===== */
.routing-grid {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.routing-row {
  display: grid;
  grid-template-columns: 80px 60px 1fr 100px;
  gap: 12px;
  align-items: center;
  padding: 10px 12px;
  background: #161616;
  border-radius: 6px;
  border: 1px solid #2a2a2a;
}
.routing-row:hover { border-color: #444; }

.routing-source {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
}

.routing-path {
  display: flex;
  align-items: center;
  gap: 4px;
}

.routing-line {
  flex: 1;
  height: 2px;
  background: var(--accent);
  border-radius: 1px;
}

.routing-arrow {
  font-size: 14px;
  color: var(--accent);
}

.routing-knobs {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.routing-dest {
  display: flex;
  justify-content: flex-end;
}

.routing-select {
  background: #222;
  border: 1px solid #333;
  color: var(--text);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 9px;
  cursor: pointer;
}
.routing-select:hover { border-color: var(--accent); }

.fx-bus {
  background: #161616;
  border-radius: 6px;
  padding: 12px;
  border: 1px solid #2a2a2a;
}

.bus-meter {
  height: 8px;
  background: #111;
  border-radius: 4px;
  overflow: hidden;
}

.bus-level {
  height: 100%;
  background: var(--accent);
  border-radius: 4px;
  transition: width 0.1s;
}

/* ===== MATRIX TAB (Serum 2 style modulation) ===== */
.mod-matrix-grid {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.mod-row {
  display: grid;
  grid-template-columns: 120px 140px 70px 70px 60px;
  gap: 8px;
  align-items: center;
  padding: 8px 12px;
  background: #161616;
  border-radius: 4px;
  border: 1px solid #2a2a2a;
  cursor: grab;
}
.mod-row:hover { border-color: #444; }
.mod-row.dragging { opacity: 0.5; border-color: var(--blue); }

.mod-header-row {
  background: transparent;
  border: none;
  cursor: default;
  padding: 4px 12px;
}

.mod-header-row .mod-cell {
  font-size: 9px;
  font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.mod-cell {
  display: flex;
  align-items: center;
  justify-content: center;
}

.mod-source-cell,
.mod-dest-cell {
  justify-content: flex-start;
}

.mod-select {
  background: #222;
  border: 1px solid #333;
  color: var(--text);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  cursor: pointer;
  width: 100%;
}
.mod-select:hover { border-color: var(--accent); }
.mod-select:focus { outline: none; border-color: var(--accent); }

.mod-curve {
  width: 50px;
}

.mod-bypass {
  width: 14px;
  height: 14px;
  background: #333;
  border-radius: 3px;
  cursor: pointer;
  border: 1px solid #444;
}
.mod-bypass:hover { border-color: var(--accent); }
.mod-bypass.active { background: var(--blue); border-color: var(--blue); }

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="plugin">
  <!-- HEADER -->
  <div class="header">
    <div class="logo">CODOX</div>
    <div class="preset-section">
      <button class="preset-nav" id="prev_preset">◀</button>
      <select id="preset_select"></select>
      <button class="preset-nav" id="next_preset">▶</button>
      <button class="preset-btn" id="save_btn">SAVE</button>
      <button class="preset-btn" id="load_btn">LOAD</button>
      <button class="preset-btn" id="random_btn">RND</button>
    </div>
    <div class="master-section">
      <span class="master-label">Master</span>
      <div class="knob-wrap">
        <div class="knob" data-param="master_volume"><div class="knob-bg"></div><div class="knob-pointer"></div></div>
      </div>
    </div>
  </div>

  <!-- NAV TABS (Serum 2 style: OSC, MIX, FX, MATRIX, GLOBAL) -->
  <div class="nav-tabs">
    <div class="nav-tab active" data-tab="osc">OSC</div>
    <div class="nav-tab" data-tab="mix">MIX</div>
    <div class="nav-tab" data-tab="fx">FX</div>
    <div class="nav-tab" data-tab="matrix">MATRIX</div>
    <div class="nav-tab" data-tab="global">GLOBAL</div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- TAB CONTENT -->
    <div class="tab-content">
      <!-- OSC TAB -->
      <div class="tab-panel active" id="tab-osc">
        <div class="osc-grid">
          <!-- OSC A -->
          <div class="osc-module">
            <div class="osc-header">
              <span class="osc-title a">OSC A</span>
              <select id="osc_a_wavetable"><option>Basic</option><option>Analog</option><option>Digital</option><option>Spectral</option><option>FM</option><option>Additive</option></select>
            </div>
            <div class="osc-wave"><canvas id="wave_a" width="340" height="80"></canvas></div>
            <div class="osc-controls">
              <div class="knob-wrap"><div class="knob" data-param="osc_a_position"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Pos</span></div>
              <div class="knob-wrap"><div class="knob" data-param="osc_a_level"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Level</span></div>
              <div class="knob-wrap"><div class="knob" data-param="osc_a_pan"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Pan</span></div>
              <div class="knob-wrap"><div class="knob" data-param="osc_a_warp_amount"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Warp</span></div>
            </div>
            <div class="osc-row">
              <div class="knob-wrap"><select id="osc_a_octave"><option>-3</option><option>-2</option><option>-1</option><option selected>0</option><option>+1</option><option>+2</option><option>+3</option></select><span class="knob-label">Oct</span></div>
              <div class="knob-wrap"><select id="osc_a_semitone"><option>-12</option><option>-7</option><option>-5</option><option selected>0</option><option>+5</option><option>+7</option><option>+12</option></select><span class="knob-label">Semi</span></div>
              <div class="knob-wrap"><div class="knob sm" data-param="osc_a_fine"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Fine</span></div>
              <div class="knob-wrap"><select id="osc_a_warp_mode"><option>Off</option><option>Sync</option><option>Bend+</option><option>Bend-</option><option>PWM</option><option>FM</option></select><span class="knob-label">Warp</span></div>
            </div>
          </div>

          <!-- OSC B -->
          <div class="osc-module">
            <div class="osc-header">
              <span class="osc-title b">OSC B</span>
              <select id="osc_b_wavetable"><option>Basic</option><option>Analog</option><option>Digital</option><option>Spectral</option><option>FM</option><option>Additive</option></select>
            </div>
            <div class="osc-wave"><canvas id="wave_b" width="340" height="80"></canvas></div>
            <div class="osc-controls">
              <div class="knob-wrap"><div class="knob" data-param="osc_b_position"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Pos</span></div>
              <div class="knob-wrap"><div class="knob" data-param="osc_b_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Level</span></div>
              <div class="knob-wrap"><div class="knob" data-param="osc_b_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Pan</span></div>
              <div class="knob-wrap"><div class="knob" data-param="osc_b_warp_amount"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Warp</span></div>
            </div>
            <div class="osc-row">
              <div class="knob-wrap"><select id="osc_b_octave"><option>-3</option><option>-2</option><option>-1</option><option selected>0</option><option>+1</option><option>+2</option><option>+3</option></select><span class="knob-label">Oct</span></div>
              <div class="knob-wrap"><select id="osc_b_semitone"><option>-12</option><option>-7</option><option>-5</option><option selected>0</option><option>+5</option><option>+7</option><option>+12</option></select><span class="knob-label">Semi</span></div>
              <div class="knob-wrap"><div class="knob sm" data-param="osc_b_fine"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Fine</span></div>
              <div class="knob-wrap"><select id="osc_b_warp_mode"><option>Off</option><option>Sync</option><option>Bend+</option><option>Bend-</option><option>PWM</option><option>FM</option></select><span class="knob-label">Warp</span></div>
            </div>
          </div>
        </div>

        <!-- SUB + NOISE -->
        <div class="sub-noise-row">
          <div class="module">
            <div class="module-header">
              <span class="module-title" style="color:var(--purple)">SUB</span>
              <select id="sub_shape"><option>Sine</option><option>Triangle</option><option>Square</option><option>Saw</option></select>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
              <div class="knob-wrap"><div class="knob" data-param="sub_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">Level</span></div>
              <div class="knob-wrap"><select id="sub_octave"><option>-2</option><option selected>-1</option><option>0</option></select><span class="knob-label">Oct</span></div>
              <div class="knob-wrap"><div class="knob" data-param="sub_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">Pan</span></div>
            </div>
          </div>
          <div class="module">
            <div class="module-header">
              <span class="module-title" style="color:var(--text-dim)">NOISE</span>
              <select id="noise_type"><option>White</option><option>Pink</option><option>Digital</option></select>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
              <div class="knob-wrap"><div class="knob" data-param="noise_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:#888"></div></div><span class="knob-label">Level</span></div>
              <div class="knob-wrap"><div class="knob" data-param="noise_color"><div class="knob-bg"></div><div class="knob-pointer" style="background:#888"></div></div><span class="knob-label">Color</span></div>
              <div class="knob-wrap"><div class="knob" data-param="noise_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:#888"></div></div><span class="knob-label">Pan</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- MIX TAB (Serum 2 style routing) -->
      <div class="tab-panel" id="tab-mix">
        <div class="module" style="margin-bottom:12px;">
          <div class="module-header"><span class="module-title" style="color:var(--accent)">SIGNAL ROUTING</span></div>
          <div class="routing-grid">
            <!-- OSC A routing -->
            <div class="routing-row">
              <div class="routing-source" style="color:var(--accent)">OSC A</div>
              <div class="routing-path">
                <div class="routing-line"></div>
                <div class="routing-arrow">→</div>
              </div>
              <div class="routing-knobs">
                <div class="knob-wrap"><div class="knob sm" data-param="osc_a_to_filt"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Filter</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="osc_a_level"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Level</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="osc_a_pan"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Pan</span></div>
              </div>
              <div class="routing-dest">
                <select class="routing-select"><option>MAIN</option><option>BUS 1</option><option>BUS 2</option></select>
              </div>
            </div>
            <!-- OSC B routing -->
            <div class="routing-row">
              <div class="routing-source" style="color:var(--orange)">OSC B</div>
              <div class="routing-path">
                <div class="routing-line" style="background:var(--orange)"></div>
                <div class="routing-arrow" style="color:var(--orange)">→</div>
              </div>
              <div class="routing-knobs">
                <div class="knob-wrap"><div class="knob sm" data-param="osc_b_to_filt"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Filter</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="osc_b_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Level</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="osc_b_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Pan</span></div>
              </div>
              <div class="routing-dest">
                <select class="routing-select"><option>MAIN</option><option>BUS 1</option><option>BUS 2</option></select>
              </div>
            </div>
            <!-- SUB routing -->
            <div class="routing-row">
              <div class="routing-source" style="color:var(--purple)">SUB</div>
              <div class="routing-path">
                <div class="routing-line" style="background:var(--purple)"></div>
                <div class="routing-arrow" style="color:var(--purple)">→</div>
              </div>
              <div class="routing-knobs">
                <div class="knob-wrap"><div class="knob sm" data-param="sub_to_filt"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">Filter</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="sub_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">Level</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="sub_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">Pan</span></div>
              </div>
              <div class="routing-dest">
                <select class="routing-select"><option>MAIN</option><option>BUS 1</option><option>BUS 2</option></select>
              </div>
            </div>
            <!-- NOISE routing -->
            <div class="routing-row">
              <div class="routing-source" style="color:var(--text-dim)">NOISE</div>
              <div class="routing-path">
                <div class="routing-line" style="background:#666"></div>
                <div class="routing-arrow" style="color:#666">→</div>
              </div>
              <div class="routing-knobs">
                <div class="knob-wrap"><div class="knob sm" data-param="noise_to_filt"><div class="knob-bg"></div><div class="knob-pointer" style="background:#888"></div></div><span class="knob-label">Filter</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="noise_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:#888"></div></div><span class="knob-label">Level</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="noise_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:#888"></div></div><span class="knob-label">Pan</span></div>
              </div>
              <div class="routing-dest">
                <select class="routing-select"><option>MAIN</option><option>BUS 1</option><option>BUS 2</option></select>
              </div>
            </div>
          </div>
        </div>

        <!-- FX Routing Section -->
        <div class="module">
          <div class="module-header"><span class="module-title" style="color:var(--blue)">FX ROUTING</span></div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <div class="fx-bus">
              <div style="color:var(--accent);font-size:10px;font-weight:700;margin-bottom:8px;">MAIN BUS</div>
              <div class="bus-meter"><div class="bus-level" style="width:70%"></div></div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <div class="knob-wrap"><div class="knob sm" data-param="main_level"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Level</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="main_pan"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Pan</span></div>
              </div>
            </div>
            <div class="fx-bus">
              <div style="color:var(--orange);font-size:10px;font-weight:700;margin-bottom:8px;">BUS 1</div>
              <div class="bus-meter"><div class="bus-level" style="width:45%;background:var(--orange)"></div></div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <div class="knob-wrap"><div class="knob sm" data-param="bus1_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Level</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="bus1_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Pan</span></div>
              </div>
            </div>
            <div class="fx-bus">
              <div style="color:var(--purple);font-size:10px;font-weight:700;margin-bottom:8px;">BUS 2</div>
              <div class="bus-meter"><div class="bus-level" style="width:30%;background:var(--purple)"></div></div>
              <div style="display:flex;gap:8px;margin-top:8px;">
                <div class="knob-wrap"><div class="knob sm" data-param="bus2_level"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">Level</span></div>
                <div class="knob-wrap"><div class="knob sm" data-param="bus2_pan"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">Pan</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FX TAB -->
      <div class="tab-panel" id="tab-fx">
        <div class="fx-grid" id="fx_container">
          <!-- Rendered by JS -->
        </div>
      </div>

      <!-- MATRIX TAB (Serum 2 style modulation) -->
      <div class="tab-panel" id="tab-matrix">
        <div class="module">
          <div class="module-header">
            <span class="module-title" style="color:var(--blue)">MODULATION MATRIX</span>
            <button class="preset-btn" id="add_mod_btn">+ ADD MOD</button>
          </div>
          <div class="mod-matrix-grid">
            <!-- Header row -->
            <div class="mod-row mod-header-row">
              <div class="mod-cell mod-source-cell">SOURCE</div>
              <div class="mod-cell mod-dest-cell">DESTINATION</div>
              <div class="mod-cell mod-amount-cell">AMOUNT</div>
              <div class="mod-cell mod-curve-cell">CURVE</div>
              <div class="mod-cell mod-bypass-cell">BYPASS</div>
            </div>
            <!-- LFO 1 → Filter Cutoff -->
            <div class="mod-row" draggable="true">
              <div class="mod-cell mod-source-cell">
                <select class="mod-select"><option>LFO 1</option><option>LFO 2</option><option>LFO 3</option><option>LFO 4</option><option>Env 1</option><option>Env 2</option><option>Vel</option><option>Note</option><option>Macro 1</option><option>Macro 2</option></select>
              </div>
              <div class="mod-cell mod-dest-cell">
                <select class="mod-select"><option>Filter Cutoff</option><option>Filter Res</option><option>OSC A Pos</option><option>OSC B Pos</option><option>OSC A Level</option><option>OSC B Level</option><option>Pan</option><option>Volume</option></select>
              </div>
              <div class="mod-cell mod-amount-cell">
                <div class="knob-wrap"><div class="knob sm" data-param="mod1_amount"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--blue)"></div></div></div>
              </div>
              <div class="mod-cell mod-curve-cell">
                <select class="mod-select mod-curve"><option>Lin</option><option>Exp</option><option>Log</option><option>S</option></select>
              </div>
              <div class="mod-cell mod-bypass-cell">
                <div class="mod-bypass active"></div>
              </div>
            </div>
            <!-- LFO 2 → OSC A Position -->
            <div class="mod-row" draggable="true">
              <div class="mod-cell mod-source-cell">
                <select class="mod-select"><option>LFO 1</option><option selected>LFO 2</option><option>LFO 3</option><option>LFO 4</option><option>Env 1</option><option>Env 2</option><option>Vel</option><option>Note</option><option>Macro 1</option><option>Macro 2</option></select>
              </div>
              <div class="mod-cell mod-dest-cell">
                <select class="mod-select"><option>Filter Cutoff</option><option>Filter Res</option><option selected>OSC A Pos</option><option>OSC B Pos</option><option>OSC A Level</option><option>OSC B Level</option><option>Pan</option><option>Volume</option></select>
              </div>
              <div class="mod-cell mod-amount-cell">
                <div class="knob-wrap"><div class="knob sm" data-param="mod2_amount"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div></div>
              </div>
              <div class="mod-cell mod-curve-cell">
                <select class="mod-select mod-curve"><option>Lin</option><option>Exp</option><option>Log</option><option>S</option></select>
              </div>
              <div class="mod-cell mod-bypass-cell">
                <div class="mod-bypass active"></div>
              </div>
            </div>
            <!-- Env 2 → Filter Resonance -->
            <div class="mod-row" draggable="true">
              <div class="mod-cell mod-source-cell">
                <select class="mod-select"><option>LFO 1</option><option>LFO 2</option><option>LFO 3</option><option>LFO 4</option><option>Env 1</option><option selected>Env 2</option><option>Vel</option><option>Note</option><option>Macro 1</option><option>Macro 2</option></select>
              </div>
              <div class="mod-cell mod-dest-cell">
                <select class="mod-select"><option>Filter Cutoff</option><option selected>Filter Res</option><option>OSC A Pos</option><option>OSC B Pos</option><option>OSC A Level</option><option>OSC B Level</option><option>Pan</option><option>Volume</option></select>
              </div>
              <div class="mod-cell mod-amount-cell">
                <div class="knob-wrap"><div class="knob sm" data-param="mod3_amount"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div></div>
              </div>
              <div class="mod-cell mod-curve-cell">
                <select class="mod-select mod-curve"><option>Lin</option><option selected>Exp</option><option>Log</option><option>S</option></select>
              </div>
              <div class="mod-cell mod-bypass-cell">
                <div class="mod-bypass"></div>
              </div>
            </div>
            <!-- Velocity → Volume -->
            <div class="mod-row" draggable="true">
              <div class="mod-cell mod-source-cell">
                <select class="mod-select"><option>LFO 1</option><option>LFO 2</option><option>LFO 3</option><option>LFO 4</option><option>Env 1</option><option>Env 2</option><option selected>Vel</option><option>Note</option><option>Macro 1</option><option>Macro 2</option></select>
              </div>
              <div class="mod-cell mod-dest-cell">
                <select class="mod-select"><option>Filter Cutoff</option><option>Filter Res</option><option>OSC A Pos</option><option>OSC B Pos</option><option>OSC A Level</option><option>OSC B Level</option><option>Pan</option><option selected>Volume</option></select>
              </div>
              <div class="mod-cell mod-amount-cell">
                <div class="knob-wrap"><div class="knob sm" data-param="mod4_amount"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--green)"></div></div></div>
              </div>
              <div class="mod-cell mod-curve-cell">
                <select class="mod-select mod-curve"><option>Lin</option><option>Exp</option><option>Log</option><option>S</option></select>
              </div>
              <div class="mod-cell mod-bypass-cell">
                <div class="mod-bypass active"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GLOBAL TAB (was SETTINGS) -->
      <div class="tab-panel" id="tab-global">
        <div class="settings-grid">
          <!-- Unison -->
          <div class="module">
            <div class="module-header"><span class="module-title" style="color:var(--green)">UNISON</span></div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
              <div class="knob-wrap"><select id="unison_voices"><option>1</option><option>2</option><option>4</option><option>8</option><option>16</option></select><span class="knob-label">Voices</span></div>
              <div class="knob-wrap"><div class="knob" data-param="unison_detune"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--green)"></div></div><span class="knob-label">Detune</span></div>
              <div class="knob-wrap"><div class="knob" data-param="unison_blend"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--green)"></div></div><span class="knob-label">Blend</span></div>
              <div class="knob-wrap"><div class="knob" data-param="unison_width"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--green)"></div></div><span class="knob-label">Width</span></div>
            </div>
          </div>

          <!-- Voice -->
          <div class="module">
            <div class="module-header"><span class="module-title" style="color:var(--blue)">VOICE</span></div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
              <div class="knob-wrap"><select id="polyphony"><option>Mono</option><option>Poly 4</option><option selected>Poly 8</option><option>Poly 16</option></select><span class="knob-label">Mode</span></div>
              <div class="knob-wrap"><div class="knob" data-param="glide_time"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--blue)"></div></div><span class="knob-label">Glide</span></div>
              <div class="knob-wrap"><select id="glide_mode"><option>Off</option><option>Always</option><option>Legato</option></select><span class="knob-label">Glide</span></div>
              <div class="knob-wrap"><div class="knob" data-param="pitch_bend"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--blue)"></div></div><span class="knob-label">Bend</span></div>
            </div>
          </div>

          <!-- Master -->
          <div class="module">
            <div class="module-header"><span class="module-title">MASTER</span></div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
              <div class="knob-wrap"><div class="knob lg" data-param="master_volume"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Volume</span></div>
              <div class="knob-wrap"><div class="knob lg" data-param="master_pan"><div class="knob-bg"></div><div class="knob-pointer"></div></div><span class="knob-label">Pan</span></div>
            </div>
          </div>
        </div>

        <!-- LFOs expanded on settings page -->
        <div class="module" style="margin-top:12px;">
          <div class="module-header"><span class="module-title" style="color:var(--blue)">LFOs</span></div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
            <div>
              <div style="font-size:10px;color:var(--blue);margin-bottom:6px;font-weight:600;">LFO 1</div>
              <div class="lfo-display"><canvas id="lfo1_canvas" width="140" height="35"></canvas></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div class="knob-wrap"><select id="lfo1_shape"><option>Sin</option><option>Tri</option><option>Saw</option><option>Sq</option><option>S&H</option></select></div>
                <div class="knob-wrap"><div class="knob sm" data-param="lfo1_rate"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--blue)"></div></div><span class="knob-label">Rate</span></div>
              </div>
            </div>
            <div>
              <div style="font-size:10px;color:var(--blue);margin-bottom:6px;font-weight:600;">LFO 2</div>
              <div class="lfo-display"><canvas id="lfo2_canvas" width="140" height="35"></canvas></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div class="knob-wrap"><select id="lfo2_shape"><option>Sin</option><option>Tri</option><option>Saw</option><option>Sq</option><option>S&H</option></select></div>
                <div class="knob-wrap"><div class="knob sm" data-param="lfo2_rate"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--blue)"></div></div><span class="knob-label">Rate</span></div>
              </div>
            </div>
            <div>
              <div style="font-size:10px;color:var(--blue);margin-bottom:6px;font-weight:600;">LFO 3</div>
              <div class="lfo-display"><canvas id="lfo3_canvas" width="140" height="35"></canvas></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div class="knob-wrap"><select id="lfo3_shape"><option>Sin</option><option>Tri</option><option>Saw</option><option>Sq</option><option>S&H</option></select></div>
                <div class="knob-wrap"><div class="knob sm" data-param="lfo3_rate"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--blue)"></div></div><span class="knob-label">Rate</span></div>
              </div>
            </div>
            <div>
              <div style="font-size:10px;color:var(--blue);margin-bottom:6px;font-weight:600;">LFO 4</div>
              <div class="lfo-display"><canvas id="lfo4_canvas" width="140" height="35"></canvas></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div class="knob-wrap"><select id="lfo4_shape"><option>Sin</option><option>Tri</option><option>Saw</option><option>Sq</option><option>S&H</option></select></div>
                <div class="knob-wrap"><div class="knob sm" data-param="lfo4_rate"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--blue)"></div></div><span class="knob-label">Rate</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SIDEBAR: Always visible -->
    <div class="sidebar">
      <!-- FILTER -->
      <div class="module">
        <div class="module-header">
          <span class="module-title" style="color:var(--orange)">FILTER</span>
          <select id="filter_type"><option>LP 24</option><option>LP 12</option><option>HP 24</option><option>HP 12</option><option>BP</option><option>Notch</option></select>
        </div>
        <div class="filter-display"><canvas id="filter_canvas" width="290" height="55"></canvas></div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
          <div class="knob-wrap"><div class="knob lg" data-param="filter_cutoff"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Cutoff</span></div>
          <div class="knob-wrap"><div class="knob lg" data-param="filter_resonance"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Res</span></div>
          <div class="knob-wrap"><div class="knob" data-param="filter_drive"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Drive</span></div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px;">
          <div class="knob-wrap"><div class="knob" data-param="filter_env_depth"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Env</span></div>
          <div class="knob-wrap"><div class="knob" data-param="filter_keytrack"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--orange)"></div></div><span class="knob-label">Key</span></div>
        </div>
      </div>

      <!-- AMP ENVELOPE -->
      <div class="module">
        <div class="module-header"><span class="module-title" style="color:var(--purple)">AMP ENV</span></div>
        <div class="env-display"><canvas id="amp_env_canvas" width="290" height="45"></canvas></div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;">
          <div class="knob-wrap"><div class="knob" data-param="amp_attack"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">A</span></div>
          <div class="knob-wrap"><div class="knob" data-param="amp_decay"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">D</span></div>
          <div class="knob-wrap"><div class="knob" data-param="amp_sustain"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">S</span></div>
          <div class="knob-wrap"><div class="knob" data-param="amp_release"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">R</span></div>
        </div>
      </div>

      <!-- FILTER ENVELOPE -->
      <div class="module">
        <div class="module-header"><span class="module-title" style="color:var(--purple)">FILTER ENV</span></div>
        <div class="env-display"><canvas id="filt_env_canvas" width="290" height="45"></canvas></div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;">
          <div class="knob-wrap"><div class="knob" data-param="filt_attack"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">A</span></div>
          <div class="knob-wrap"><div class="knob" data-param="filt_decay"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">D</span></div>
          <div class="knob-wrap"><div class="knob" data-param="filt_sustain"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">S</span></div>
          <div class="knob-wrap"><div class="knob" data-param="filt_release"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--purple)"></div></div><span class="knob-label">R</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MACROS BAR -->
  <div class="macros-bar">
    <span class="macros-label">Macros</span>
    <div class="macros-row">
      <div class="knob-wrap"><div class="knob" data-param="macro1"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">1</span></div>
      <div class="knob-wrap"><div class="knob" data-param="macro2"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">2</span></div>
      <div class="knob-wrap"><div class="knob" data-param="macro3"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">3</span></div>
      <div class="knob-wrap"><div class="knob" data-param="macro4"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">4</span></div>
      <div class="knob-wrap"><div class="knob" data-param="macro5"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">5</span></div>
      <div class="knob-wrap"><div class="knob" data-param="macro6"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">6</span></div>
      <div class="knob-wrap"><div class="knob" data-param="macro7"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">7</span></div>
      <div class="knob-wrap"><div class="knob" data-param="macro8"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--yellow)"></div></div><span class="knob-label">8</span></div>
    </div>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-overlay" id="save_modal">
  <div class="modal">
    <div class="modal-title">Save Preset</div>
    <input type="text" class="modal-input" id="preset_name" placeholder="Preset name...">
    <div class="modal-btns">
      <button class="modal-btn secondary" id="modal_cancel">Cancel</button>
      <button class="modal-btn primary" id="modal_save">Save</button>
    </div>
  </div>
</div>

<input type="file" id="file_input" accept=".json,.codox" style="display:none">

<script>
(function() {
'use strict';

// ============================================
// CODOX v2.1.0 - Serum 2-Style Wavetable Synth
// 5 Tabs: OSC, MIX, FX, MATRIX, GLOBAL
// ============================================

const canvases = {};
const sliderStates = {};
const comboStates = {};
let frame = 0;

// FX definitions
const fxList = [
  { id: 'distortion', name: 'DISTORTION', color: '#00d4aa', params: ['fx_distortion_mix', 'fx_distortion_drive'] },
  { id: 'chorus', name: 'CHORUS', color: '#3498db', params: ['fx_chorus_mix', 'fx_chorus_rate', 'fx_chorus_depth'] },
  { id: 'phaser', name: 'PHASER', color: '#e74c3c', params: ['fx_phaser_mix', 'fx_phaser_rate', 'fx_phaser_depth'] },
  { id: 'flanger', name: 'FLANGER', color: '#9b59b6', params: ['fx_flanger_mix', 'fx_flanger_rate', 'fx_flanger_feedback'] },
  { id: 'delay', name: 'DELAY', color: '#f39c12', params: ['fx_delay_mix', 'fx_delay_time', 'fx_delay_feedback', 'fx_delay_sync'] },
  { id: 'reverb', name: 'REVERB', color: '#1abc9c', params: ['fx_reverb_mix', 'fx_reverb_size', 'fx_reverb_decay'] },
  { id: 'eq', name: 'EQ', color: '#e91e63', params: ['fx_eq_mix', 'fx_eq_low', 'fx_eq_mid', 'fx_eq_high'] },
  { id: 'compressor', name: 'COMPRESSOR', color: '#ff5722', params: ['fx_compressor_mix', 'fx_compressor_threshold', 'fx_compressor_ratio'] }
];

// Factory presets
const factoryPresets = {
  'Init': { osc_a_level: 1, osc_b_level: 0, filter_cutoff: 1, amp_sustain: 1 },
  'Serum Lead': { osc_a_position: 0.3, osc_a_level: 1, osc_b_position: 0.5, osc_b_level: 0.7, filter_cutoff: 0.6, filter_resonance: 0.3, amp_decay: 0.15, amp_sustain: 0.7, sub_level: 0.2, fx_chorus_mix: 0.2, fx_reverb_mix: 0.15 },
  'Fat Bass': { osc_a_level: 1, osc_a_warp_amount: 0.4, osc_b_level: 0.8, filter_cutoff: 0.35, filter_resonance: 0.4, filter_drive: 0.5, amp_decay: 0.2, amp_sustain: 0.6, sub_level: 0.6, fx_distortion_mix: 0.3 },
  'Ethereal Pad': { osc_a_position: 0.4, osc_a_level: 0.7, osc_b_position: 0.6, osc_b_level: 0.7, filter_cutoff: 0.5, amp_attack: 0.4, amp_sustain: 0.8, amp_release: 0.5, fx_chorus_mix: 0.4, fx_reverb_mix: 0.5, fx_delay_mix: 0.3 },
  'Pluck': { osc_a_level: 1, osc_b_level: 0.5, filter_cutoff: 0.7, filter_env_depth: 0.5, amp_decay: 0.3, amp_sustain: 0, fx_reverb_mix: 0.25, fx_delay_mix: 0.2 },
  'Growl Bass': { osc_a_warp_amount: 0.7, osc_b_warp_amount: 0.8, filter_cutoff: 0.4, filter_resonance: 0.5, filter_drive: 0.6, sub_level: 0.4, fx_distortion_mix: 0.5 },
  'Supersaw': { osc_a_position: 0.8, osc_a_level: 1, osc_b_position: 0.8, osc_b_level: 1, filter_cutoff: 0.75, unison_detune: 0.4, fx_chorus_mix: 0.3, fx_reverb_mix: 0.2 },
  'Bell': { osc_a_warp_amount: 0.3, osc_b_warp_amount: 0.4, filter_cutoff: 0.8, amp_decay: 0.6, amp_sustain: 0.1, amp_release: 0.4, fx_reverb_mix: 0.4, fx_delay_mix: 0.25 },
  'Wobble': { osc_a_warp_amount: 0.5, osc_b_warp_amount: 0.6, filter_cutoff: 0.5, filter_resonance: 0.6, filter_drive: 0.4, sub_level: 0.3, fx_distortion_mix: 0.2 },
  'Ambient': { osc_a_position: 0.25, osc_a_level: 0.6, osc_b_position: 0.35, osc_b_level: 0.6, filter_cutoff: 0.45, amp_attack: 0.6, amp_sustain: 0.7, amp_release: 0.7, noise_level: 0.08, fx_chorus_mix: 0.35, fx_reverb_mix: 0.6, fx_delay_mix: 0.4 }
};

let userPresets = {};
try { const s = localStorage.getItem('codox_presets'); if (s) userPresets = JSON.parse(s); } catch(e) {}

// Init
function init() {
  document.addEventListener('contextmenu', e => e.preventDefault());
  initCanvases();
  initTabs();
  initKnobs();
  initFX();
  initMatrix();
  initPresets();
  initModal();
  connectJUCE();
  requestAnimationFrame(animate);
  console.log('Codox v2.1.0 ready');
}

// Canvases
function initCanvases() {
  ['wave_a', 'wave_b', 'filter_canvas', 'amp_env_canvas', 'filt_env_canvas',
   'lfo1_canvas', 'lfo2_canvas', 'lfo3_canvas', 'lfo4_canvas'].forEach(id => {
    const c = document.getElementById(id);
    if (c) canvases[id] = { el: c, ctx: c.getContext('2d'), w: c.width, h: c.height };
  });
}

// Tabs
function initTabs() {
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
  });
}

// Animation
function animate() {
  frame++;
  const t = frame * 0.02;
  drawWave('wave_a', getVal('osc_a_wavetable'), t, getKnob('osc_a_position'));
  drawWave('wave_b', getVal('osc_b_wavetable'), t * 1.1, getKnob('osc_b_position'));
  drawFilter(getKnob('filter_cutoff'), getKnob('filter_resonance'));
  drawEnv('amp_env_canvas', getKnob('amp_attack'), getKnob('amp_decay'), getKnob('amp_sustain'), getKnob('amp_release'));
  drawEnv('filt_env_canvas', getKnob('filt_attack'), getKnob('filt_decay'), getKnob('filt_sustain'), getKnob('filt_release'));
  drawLFO('lfo1_canvas', getVal('lfo1_shape'), t * 0.5);
  drawLFO('lfo2_canvas', getVal('lfo2_shape'), t * 0.7);
  drawLFO('lfo3_canvas', getVal('lfo3_shape'), t * 0.3);
  drawLFO('lfo4_canvas', getVal('lfo4_shape'), t * 0.4);
  requestAnimationFrame(animate);
}

function drawWave(id, type, phase, pos) {
  const c = canvases[id]; if (!c) return;
  const { ctx, w, h } = c;
  ctx.clearRect(0, 0, w, h);
  ctx.strokeStyle = 'rgba(0,212,170,0.1)';
  for (let i = 0; i < 5; i++) { ctx.beginPath(); ctx.moveTo(0, h*i/5); ctx.lineTo(w, h*i/5); ctx.stroke(); }
  for (let layer = 3; layer >= 0; layer--) {
    ctx.strokeStyle = `rgba(0,212,170,${0.2 + (4 - layer) * 0.2})`;
    ctx.lineWidth = layer === 0 ? 2 : 1;
    ctx.beginPath();
    for (let x = 0; x <= w; x++) {
      const tt = (x / w + phase + layer * 0.08) % 1;
      let y = waveFunc(type, tt, pos + layer * 0.05);
      const py = h / 2 - y * h * 0.38 + layer * 2;
      x === 0 ? ctx.moveTo(x, py) : ctx.lineTo(x, py);
    }
    ctx.stroke();
  }
}

function waveFunc(type, t, p) {
  switch (type) {
    case 0: return Math.sin(t * Math.PI * 4) * (1 - p) + (1 - 2 * ((t * 2) % 1)) * p;
    case 1: let s = 0; for (let h = 1; h <= 8; h++) s += Math.sin(t * Math.PI * 4 * h) / h; return s * 0.5;
    case 2: return Math.sin(t * Math.PI * 4 + p * Math.sin(t * Math.PI * 16)) * 0.9;
    case 3: return Math.sin(t * Math.PI * 4) * Math.cos(t * Math.PI * 2 * (1 + p * 3));
    case 4: return Math.sin(t * Math.PI * 4 + p * 4 * Math.sin(t * Math.PI * 8));
    case 5: let a = 0; for (let h = 1; h <= 6; h++) a += Math.sin(t * Math.PI * 4 * h) * (1 - p + p * ((h % 2) * 2 - 1)); return a * 0.3;
    default: return Math.sin(t * Math.PI * 4);
  }
}

function drawFilter(cutoff, res) {
  const c = canvases['filter_canvas']; if (!c) return;
  const { ctx, w, h } = c;
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = 'rgba(255,140,66,0.12)';
  ctx.beginPath(); ctx.moveTo(0, h);
  for (let x = 0; x <= w; x++) {
    const f = x / w;
    let g = f <= cutoff * 0.9 ? 1 : Math.pow(Math.max(0, 1 - (f - cutoff * 0.9) / (1 - cutoff * 0.9 + 0.01)), 2);
    g += res * 0.8 * Math.exp(-Math.pow(f - cutoff * 0.9, 2) * 100);
    ctx.lineTo(x, h - g * h * 0.85);
  }
  ctx.lineTo(w, h); ctx.fill();
  ctx.strokeStyle = '#ff8c42'; ctx.lineWidth = 2;
  ctx.beginPath();
  for (let x = 0; x <= w; x++) {
    const f = x / w;
    let g = f <= cutoff * 0.9 ? 1 : Math.pow(Math.max(0, 1 - (f - cutoff * 0.9) / (1 - cutoff * 0.9 + 0.01)), 2);
    g += res * 0.8 * Math.exp(-Math.pow(f - cutoff * 0.9, 2) * 100);
    x === 0 ? ctx.moveTo(x, h - g * h * 0.85) : ctx.lineTo(x, h - g * h * 0.85);
  }
  ctx.stroke();
}

function drawEnv(id, a, d, s, r) {
  const c = canvases[id]; if (!c) return;
  const { ctx, w, h } = c;
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = 'rgba(155,89,182,0.15)';
  ctx.beginPath();
  let x = 2; ctx.moveTo(x, h - 2);
  x += a * 0.3 * w; ctx.lineTo(x, 3);
  x += d * 0.25 * w; ctx.lineTo(x, 3 + (1 - s) * (h - 6));
  x += 0.2 * w; ctx.lineTo(x, 3 + (1 - s) * (h - 6));
  x += r * 0.25 * w; ctx.lineTo(x, h - 2);
  ctx.lineTo(2, h - 2); ctx.fill();
  ctx.strokeStyle = '#9b59b6'; ctx.lineWidth = 2;
  ctx.beginPath(); x = 2; ctx.moveTo(x, h - 2);
  x += a * 0.3 * w; ctx.lineTo(x, 3);
  x += d * 0.25 * w; ctx.lineTo(x, 3 + (1 - s) * (h - 6));
  x += 0.2 * w; ctx.lineTo(x, 3 + (1 - s) * (h - 6));
  x += r * 0.25 * w; ctx.lineTo(x, h - 2);
  ctx.stroke();
}

function drawLFO(id, shape, phase) {
  const c = canvases[id]; if (!c) return;
  const { ctx, w, h } = c;
  ctx.clearRect(0, 0, w, h);
  ctx.strokeStyle = '#3498db'; ctx.lineWidth = 1.5;
  ctx.beginPath();
  for (let x = 0; x <= w; x++) {
    const t = (x / w + phase) % 1;
    let y = 0;
    switch (shape) {
      case 0: y = Math.sin(t * Math.PI * 2); break;
      case 1: y = Math.abs(((t * 2) % 2) - 1) * 2 - 1; break;
      case 2: y = 1 - 2 * (t % 1); break;
      case 3: y = t < 0.5 ? 1 : -1; break;
      default: y = Math.random() * 2 - 1;
    }
    const py = h / 2 - y * h * 0.4;
    x === 0 ? ctx.moveTo(x, py) : ctx.lineTo(x, py);
  }
  ctx.stroke();
}

// Knobs
function initKnobs() {
  let active = null, startY = 0, startVal = 0;

  document.querySelectorAll('.knob[data-param]').forEach(k => {
    const p = k.dataset.param;
    updateKnob(k, 0.5);

    k.addEventListener('mousedown', e => {
      e.preventDefault();
      e.stopPropagation();
      active = { el: k, param: p };
      startY = e.clientY;
      startVal = sliderStates[p] ? sliderStates[p].getNormalisedValue() : 0.5;
      document.body.style.cursor = 'ns-resize';
    });

    k.addEventListener('dblclick', e => {
      e.stopPropagation();
      const s = sliderStates[p];
      if (s) s.setNormalisedValue(0.5);
      updateKnob(k, 0.5);
    });
  });

  document.addEventListener('mousemove', e => {
    if (!active) return;
    const dy = startY - e.clientY;
    const sens = e.shiftKey ? 0.001 : 0.005;
    let v = Math.max(0, Math.min(1, startVal + dy * sens));
    const s = sliderStates[active.param];
    if (s) s.setNormalisedValue(v);
    updateKnob(active.el, v);
  });

  document.addEventListener('mouseup', () => {
    if (active) { document.body.style.cursor = ''; active = null; }
  });
}

function updateKnob(k, v) {
  const ptr = k.querySelector('.knob-pointer');
  if (ptr) ptr.style.transform = `translateX(-50%) rotate(${-135 + v * 270}deg)`;
}

function getKnob(p) {
  const s = sliderStates[p];
  return s ? s.getNormalisedValue() : 0.5;
}

function getVal(id) {
  const el = document.getElementById(id);
  return el ? el.selectedIndex : 0;
}

// FX
function initFX() {
  const container = document.getElementById('fx_container');
  container.innerHTML = '';

  fxList.forEach(fx => {
    const unit = document.createElement('div');
    unit.className = 'fx-unit';
    unit.dataset.fx = fx.id;
    unit.draggable = true;

    const labels = { mix: 'Mix', drive: 'Drive', rate: 'Rate', depth: 'Depth', feedback: 'Fdbk', time: 'Time', size: 'Size', decay: 'Decay', low: 'Low', mid: 'Mid', high: 'High', threshold: 'Thrs', ratio: 'Ratio', sync: 'Sync' };

    let knobsHtml = fx.params.map(p => {
      const lbl = Object.keys(labels).find(k => p.includes(k)) || 'Mix';
      if (p.includes('sync')) {
        return `<div class="knob-wrap"><select id="${p}" style="width:50px"><option>Off</option><option>On</option></select><span class="knob-label">${labels[lbl]}</span></div>`;
      }
      return `<div class="knob-wrap"><div class="knob sm" data-param="${p}"><div class="knob-bg"></div><div class="knob-pointer" style="background:${fx.color}"></div></div><span class="knob-label">${labels[lbl]}</span></div>`;
    }).join('');

    unit.innerHTML = `
      <div class="fx-header">
        <span class="fx-name" style="color:${fx.color}">${fx.name}</span>
        <div class="fx-toggle" data-fx="${fx.id}"></div>
      </div>
      <div class="fx-controls">${knobsHtml}</div>
    `;

    // Toggle
    const toggle = unit.querySelector('.fx-toggle');
    toggle.addEventListener('click', e => {
      e.stopPropagation();
      const mixP = fx.params[0];
      const isOn = toggle.classList.contains('active');
      const s = sliderStates[mixP];
      const knob = unit.querySelector(`.knob[data-param="${mixP}"]`);
      if (isOn) {
        if (s) s.setNormalisedValue(0);
        if (knob) updateKnob(knob, 0);
        toggle.classList.remove('active');
      } else {
        if (s) s.setNormalisedValue(0.5);
        if (knob) updateKnob(knob, 0.5);
        toggle.classList.add('active');
      }
    });

    // Drag
    unit.addEventListener('dragstart', e => { e.dataTransfer.setData('text', fx.id); unit.classList.add('dragging'); });
    unit.addEventListener('dragend', () => unit.classList.remove('dragging'));
    unit.addEventListener('dragover', e => {
      e.preventDefault();
      const dragging = container.querySelector('.dragging');
      if (dragging && dragging !== unit) {
        const rect = unit.getBoundingClientRect();
        if (e.clientY < rect.top + rect.height / 2) container.insertBefore(dragging, unit);
        else container.insertBefore(dragging, unit.nextSibling);
      }
    });

    container.appendChild(unit);
  });

  // Reinit knobs for FX
  document.querySelectorAll('#fx_container .knob[data-param]').forEach(k => {
    const p = k.dataset.param;
    updateKnob(k, 0);

    k.addEventListener('mousedown', e => {
      e.preventDefault();
      e.stopPropagation();
      const startY = e.clientY;
      const s = sliderStates[p];
      let startVal = s ? s.getNormalisedValue() : 0;

      const move = ev => {
        const dy = startY - ev.clientY;
        const sens = ev.shiftKey ? 0.001 : 0.005;
        let v = Math.max(0, Math.min(1, startVal + dy * sens));
        if (s) s.setNormalisedValue(v);
        updateKnob(k, v);
        // Update toggle
        if (p.endsWith('_mix')) {
          const fxId = p.replace('fx_', '').replace('_mix', '');
          const tog = document.querySelector(`.fx-toggle[data-fx="${fxId}"]`);
          if (tog) tog.classList.toggle('active', v > 0.01);
        }
      };

      const up = () => {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
        document.body.style.cursor = '';
      };

      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', up);
      document.body.style.cursor = 'ns-resize';
    });
  });
}

// Matrix (Modulation)
// Source name to C++ ModSource enum mapping
const modSourceMap = {
  'LFO 1': 0, 'LFO 2': 1, 'LFO 3': 2, 'LFO 4': 3,
  'Env 1': 4, 'Env 2': 5, 'Vel': 6, 'Note': 8,
  'Macro 1': 11, 'Macro 2': 12, 'Macro 3': 13, 'Macro 4': 14
};

// Destination name to parameter ID mapping
const modDestMap = {
  'Filter Cutoff': 'filter_cutoff',
  'Filter Res': 'filter_resonance',
  'OSC A Pos': 'osc_a_position',
  'OSC B Pos': 'osc_b_position',
  'OSC A Level': 'osc_a_level',
  'OSC B Level': 'osc_b_level',
  'Pan': 'osc_a_pan',
  'Volume': 'master_volume',
  'OSC A Warp': 'osc_a_warp_amount',
  'OSC B Warp': 'osc_b_warp_amount',
  'Sub Level': 'sub_level',
  'Noise Level': 'noise_level'
};

// Send modulation route to C++
function sendModRoute(source, dest, amount, bypass) {
  if (window.__JUCE__ && window.__JUCE__.backend) {
    const sourceId = modSourceMap[source] ?? 0;
    const destParam = modDestMap[dest] ?? 'filter_cutoff';
    const depth = bypass ? 0 : (amount - 0.5) * 2; // Convert 0-1 to -1 to +1
    window.__JUCE__.backend.setModRoute(sourceId, destParam, depth);
  }
}

// Collect and send all routes
function syncAllModRoutes() {
  const rows = document.querySelectorAll('.mod-row:not(.mod-header-row)');
  rows.forEach((row, index) => {
    const sourceSelect = row.querySelector('.mod-source-cell select');
    const destSelect = row.querySelector('.mod-dest-cell select');
    const knob = row.querySelector('.knob');
    const bypass = row.querySelector('.mod-bypass');

    if (sourceSelect && destSelect && knob) {
      const source = sourceSelect.value;
      const dest = destSelect.value;
      const amount = getKnobValue(knob);
      const isBypassed = bypass && !bypass.classList.contains('active');
      sendModRoute(source, dest, amount, isBypassed);
    }
  });
}

function getKnobValue(knob) {
  const ptr = knob.querySelector('.knob-pointer');
  if (!ptr) return 0.5;
  const transform = ptr.style.transform || '';
  const match = transform.match(/rotate\((-?\d+(?:\.\d+)?)deg\)/);
  if (match) {
    const deg = parseFloat(match[1]);
    return (deg + 135) / 270; // Convert -135 to +135 to 0-1
  }
  return 0.5;
}

function initMatrix() {
  // Bypass toggles
  document.querySelectorAll('.mod-bypass').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('active');
      syncAllModRoutes();
    });
  });

  // Source/dest select change handlers
  document.querySelectorAll('.mod-row:not(.mod-header-row) select').forEach(sel => {
    sel.addEventListener('change', () => syncAllModRoutes());
  });

  // Matrix row drag and drop
  const rows = document.querySelectorAll('.mod-row:not(.mod-header-row)');
  rows.forEach(row => {
    row.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text', '');
      row.classList.add('dragging');
    });
    row.addEventListener('dragend', () => row.classList.remove('dragging'));
    row.addEventListener('dragover', e => {
      e.preventDefault();
      const dragging = document.querySelector('.mod-row.dragging');
      if (dragging && dragging !== row) {
        const parent = row.parentElement;
        const rect = row.getBoundingClientRect();
        if (e.clientY < rect.top + rect.height / 2) {
          parent.insertBefore(dragging, row);
        } else {
          parent.insertBefore(dragging, row.nextSibling);
        }
      }
    });
  });

  // Add mod button
  const addBtn = document.getElementById('add_mod_btn');
  if (addBtn) {
    addBtn.addEventListener('click', () => {
      const grid = document.querySelector('.mod-matrix-grid');
      const newRow = document.createElement('div');
      newRow.className = 'mod-row';
      newRow.draggable = true;
      newRow.innerHTML = `
        <div class="mod-cell mod-source-cell">
          <select class="mod-select"><option>LFO 1</option><option>LFO 2</option><option>LFO 3</option><option>LFO 4</option><option>Env 1</option><option>Env 2</option><option>Vel</option><option>Note</option><option>Macro 1</option><option>Macro 2</option></select>
        </div>
        <div class="mod-cell mod-dest-cell">
          <select class="mod-select"><option>Filter Cutoff</option><option>Filter Res</option><option>OSC A Pos</option><option>OSC B Pos</option><option>OSC A Level</option><option>OSC B Level</option><option>Pan</option><option>Volume</option></select>
        </div>
        <div class="mod-cell mod-amount-cell">
          <div class="knob-wrap"><div class="knob sm" data-param="mod_new"><div class="knob-bg"></div><div class="knob-pointer" style="background:var(--accent)"></div></div></div>
        </div>
        <div class="mod-cell mod-curve-cell">
          <select class="mod-select mod-curve"><option>Lin</option><option>Exp</option><option>Log</option><option>S</option></select>
        </div>
        <div class="mod-cell mod-bypass-cell">
          <div class="mod-bypass active"></div>
        </div>
      `;
      grid.appendChild(newRow);

      // Add listeners to new row
      newRow.querySelector('.mod-bypass').addEventListener('click', e => {
        e.target.classList.toggle('active');
        syncAllModRoutes();
      });

      newRow.querySelectorAll('select').forEach(sel => {
        sel.addEventListener('change', () => syncAllModRoutes());
      });

      newRow.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text', '');
        newRow.classList.add('dragging');
      });
      newRow.addEventListener('dragend', () => newRow.classList.remove('dragging'));

      // Sync after adding new route
      syncAllModRoutes();
    });
  }

  // Initial sync after JUCE connection
  setTimeout(syncAllModRoutes, 1000);
}

// Presets
function initPresets() {
  const sel = document.getElementById('preset_select');
  sel.innerHTML = '';
  Object.keys(factoryPresets).forEach(n => {
    const o = document.createElement('option');
    o.value = n; o.textContent = n;
    sel.appendChild(o);
  });
  Object.keys(userPresets).forEach(n => {
    const o = document.createElement('option');
    o.value = n; o.textContent = n + ' *';
    sel.appendChild(o);
  });

  sel.addEventListener('change', () => loadPreset(sel.value));
  document.getElementById('prev_preset').addEventListener('click', () => { if (sel.selectedIndex > 0) { sel.selectedIndex--; loadPreset(sel.value); }});
  document.getElementById('next_preset').addEventListener('click', () => { if (sel.selectedIndex < sel.options.length - 1) { sel.selectedIndex++; loadPreset(sel.value); }});
  document.getElementById('random_btn').addEventListener('click', randomize);
  document.getElementById('load_btn').addEventListener('click', () => {
    // Call native C++ function to open file dialog
    if (window.__JUCE__ && window.__JUCE__.backend) {
      window.__JUCE__.backend.loadPresetFromFile();
    }
  });

  // Keep file_input as fallback for drag-drop or direct file selection
  document.getElementById('file_input').addEventListener('change', e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => { try { applyPreset(JSON.parse(ev.target.result)); } catch(err) { console.error(err); }};
    r.readAsText(f);
  });
}

function loadPreset(name) {
  if (factoryPresets[name]) applyPreset(factoryPresets[name]);
  else if (userPresets[name]) applyPreset(userPresets[name]);
}

function applyPreset(data) {
  for (const [p, v] of Object.entries(data)) {
    const s = sliderStates[p];
    if (s) s.setNormalisedValue(v);
    const k = document.querySelector(`.knob[data-param="${p}"]`);
    if (k) updateKnob(k, v);
  }
  // Refresh FX toggles
  fxList.forEach(fx => {
    const v = data[fx.params[0]] || 0;
    const tog = document.querySelector(`.fx-toggle[data-fx="${fx.id}"]`);
    if (tog) tog.classList.toggle('active', v > 0.01);
  });
}

// Called from C++ after loading a preset file
// Must be global so C++ evaluateJavascript can call it
window.applyPresetFromFile = function(jsonString) {
  try {
    const data = JSON.parse(jsonString);
    applyPreset(data);
    showToast('Preset loaded!');
  } catch(err) {
    console.error('Failed to parse preset:', err);
    showToast('Failed to load preset');
  }
};

function getCurrentState() {
  const state = {};
  document.querySelectorAll('.knob[data-param]').forEach(k => {
    const p = k.dataset.param;
    const s = sliderStates[p];
    state[p] = s ? s.getNormalisedValue() : 0.5;
  });
  return state;
}

function randomize() {
  applyPreset({
    osc_a_position: Math.random(), osc_a_level: 0.7 + Math.random() * 0.3, osc_a_warp_amount: Math.random() * 0.6,
    osc_b_position: Math.random(), osc_b_level: Math.random() * 0.8, osc_b_warp_amount: Math.random() * 0.6,
    filter_cutoff: 0.3 + Math.random() * 0.6, filter_resonance: Math.random() * 0.5, filter_drive: Math.random() * 0.4,
    amp_attack: Math.random() * 0.3, amp_decay: 0.05 + Math.random() * 0.4, amp_sustain: 0.3 + Math.random() * 0.6, amp_release: 0.05 + Math.random() * 0.4,
    sub_level: Math.random() * 0.4, noise_level: Math.random() * 0.15,
    fx_distortion_mix: Math.random() * 0.3, fx_chorus_mix: Math.random() * 0.4, fx_reverb_mix: Math.random() * 0.5, fx_delay_mix: Math.random() * 0.4
  });
}

// Modal
function initModal() {
  const modal = document.getElementById('save_modal');
  const input = document.getElementById('preset_name');
  const saveBtn = document.getElementById('modal_save');

  // Save preset function
  function doSavePreset() {
    const name = input.value.trim();
    if (!name) {
      input.focus();
      return;
    }
    if (factoryPresets[name]) {
      input.placeholder = 'Cannot overwrite factory!';
      input.value = '';
      input.focus();
      return;
    }

    const state = getCurrentState();
    const jsonData = JSON.stringify(state, null, 2);

    // Call native C++ function to save preset file directly (no dialog)
    if (window.__JUCE__ && window.__JUCE__.backend && typeof window.__JUCE__.backend.savePresetToFile === 'function') {
      window.__JUCE__.backend.savePresetToFile(jsonData, name);
    }

    // Store in memory for session
    userPresets[name] = state;
    showToast('Preset "' + name + '" saved to ~/Documents/Codox Presets/');

    // Add to dropdown
    const sel = document.getElementById('preset_select');
    let found = false;
    for (const o of sel.options) if (o.value === name) { found = true; break; }
    if (!found) {
      const o = document.createElement('option');
      o.value = name; o.textContent = name + ' *';
      sel.appendChild(o);
    }
    sel.value = name;

    modal.classList.remove('active');
  }

  // Open modal
  document.getElementById('save_btn').addEventListener('click', () => {
    input.value = '';
    modal.classList.add('active');
    setTimeout(() => input.focus(), 100);
  });

  // Close modal
  document.getElementById('modal_cancel').addEventListener('click', () => modal.classList.remove('active'));
  modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });

  // Save on button click
  saveBtn.addEventListener('click', doSavePreset);

  // Save on Enter key in input field
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      doSavePreset();
    }
    if (e.key === 'Escape') {
      modal.classList.remove('active');
    }
  });
}

// JUCE connection
async function connectJUCE() {
  try {
    const m = await import('./js/juce/index.js');
    if (window.__JUCE__ && window.__JUCE__.backend) {
      bindParams(m);
      console.log('JUCE connected');
    }
  } catch(e) { setTimeout(connectJUCE, 500); }
}

function bindParams(Juce) {
  document.querySelectorAll('.knob[data-param]').forEach(k => {
    const p = k.dataset.param;
    try {
      const s = Juce.getSliderState(p);
      if (s) {
        sliderStates[p] = s;
        s.valueChangedEvent.addListener(() => {
          const v = s.getNormalisedValue();
          updateKnob(k, v);
          if (p.endsWith('_mix') && p.startsWith('fx_')) {
            const fxId = p.replace('fx_', '').replace('_mix', '');
            const tog = document.querySelector(`.fx-toggle[data-fx="${fxId}"]`);
            if (tog) tog.classList.toggle('active', v > 0.01);
          }
        });
        updateKnob(k, s.getNormalisedValue());
      }
    } catch(e) {}
  });

  // Combos
  ['osc_a_wavetable', 'osc_b_wavetable', 'osc_a_octave', 'osc_b_octave', 'osc_a_semitone', 'osc_b_semitone',
   'osc_a_warp_mode', 'osc_b_warp_mode', 'filter_type', 'sub_shape', 'sub_octave', 'noise_type',
   'lfo1_shape', 'lfo2_shape', 'lfo3_shape', 'lfo4_shape', 'unison_voices', 'polyphony', 'glide_mode'].forEach(id => {
    const el = document.getElementById(id); if (!el) return;
    try {
      const s = Juce.getComboBoxState(id);
      if (s) {
        comboStates[id] = s;
        s.valueChangedEvent.addListener(() => el.selectedIndex = s.getChoiceIndex());
        el.addEventListener('change', () => s.setChoiceIndex(el.selectedIndex));
        el.selectedIndex = s.getChoiceIndex();
      }
    } catch(e) {}
  });
}

// Toast notification
function showToast(msg) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--accent);color:#000;padding:10px 24px;border-radius:6px;font-size:12px;font-weight:600;opacity:0;transition:opacity 0.3s;z-index:9999;pointer-events:none;';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 2000);
}

// Start
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
else init();
})();
</script>
</body>
</html>
